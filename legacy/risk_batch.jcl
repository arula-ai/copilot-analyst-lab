//RISKBAT  JOB (RISK),'CUSTOMER RISK BATCH',CLASS=B,MSGCLASS=X,
//         NOTIFY=&SYSUID,REGION=8M,TIME=(0,30)
//*
//* *********************************************************
//* CUSTOMER RISK SCORING BATCH JOB
//* RUNS: WEEKLY ON SUNDAY AT 03:00 AM
//* DEPENDENCIES: TRANSACTION FILES MUST BE COMPLETE
//* CRITICAL: FEEDS COMPLIANCE AND FRAUD PREVENTION SYSTEMS
//* *********************************************************
//*
//JOBPROC  PROC
//*
//* STEP 1: DELETE OLD WORK FILES
//*
//CLEANUP  EXEC PGM=IEFBR14
//OLDWORK  DD DSN=WORK.RISK.TRANS.EXTRACT,
//            DISP=(MOD,DELETE,DELETE),UNIT=SYSDA,SPACE=(TRK,0)
//OLDOUT   DD DSN=WORK.RISK.OUTPUT.TEMP,
//            DISP=(MOD,DELETE,DELETE),UNIT=SYSDA,SPACE=(TRK,0)
//*
//* STEP 2: EXTRACT TRANSACTIONS FOR RISK ANALYSIS
//*
//EXTRACT  EXEC PGM=SORT
//SYSOUT   DD SYSOUT=*
//SORTIN   DD DSN=PROD.TRANS.MASTER,DISP=SHR
//         DD DSN=PROD.TRANS.PENDING,DISP=SHR
//SORTOUT  DD DSN=WORK.RISK.TRANS.EXTRACT,
//            DISP=(NEW,CATLG,DELETE),
//            UNIT=SYSDA,SPACE=(CYL,(200,100),RLSE),
//            DCB=(RECFM=FB,LRECL=200,BLKSIZE=20000)
//SYSIN    DD *
  SORT FIELDS=(1,10,CH,A,11,8,CH,A)
  INCLUDE COND=(150,2,CH,EQ,C'AP',OR,
                150,2,CH,EQ,C'DC',OR,
                150,2,CH,EQ,C'PN')
/*
//*
//* STEP 3: BUILD INDEXED FILE FOR CUSTOMER LOOKUP
//*
//BUILDIX  EXEC PGM=IDCAMS
//SYSPRINT DD SYSOUT=*
//SYSIN    DD *
  DELETE PROD.CUST.TRANS.INDEX PURGE
  SET MAXCC=0
  
  DEFINE CLUSTER(NAME(PROD.CUST.TRANS.INDEX) -
         INDEXED -
         RECORDSIZE(200 200) -
         KEYS(18 0) -
         CISZ(4096) -
         FREESPACE(10 10) -
         VOLUMES(WORK01) -
         CYLINDERS(250 50)) -
    DATA(NAME(PROD.CUST.TRANS.INDEX.DATA)) -
    INDEX(NAME(PROD.CUST.TRANS.INDEX.INDEX))
  
  REPRO INFILE(SORTOUT) -
        OUTFILE(CLSTROUT)
/*
//SORTOUT  DD DSN=WORK.RISK.TRANS.EXTRACT,DISP=SHR
//CLSTROUT DD DSN=PROD.CUST.TRANS.INDEX,DISP=SHR
//*
//* STEP 4: RUN CUSTOMER RISK SCORING PROGRAM
//*
//RISKRUN  EXEC PGM=CUSTRISK,COND=(4,LT)
//STEPLIB  DD DSN=PROD.LOADLIB,DISP=SHR
//CUSTTRAN DD DSN=PROD.CUST.TRANS.INDEX,DISP=SHR
//RISKOUT  DD DSN=WORK.RISK.OUTPUT.TEMP,
//            DISP=(NEW,CATLG,DELETE),
//            UNIT=SYSDA,SPACE=(CYL,(50,25),RLSE),
//            DCB=(RECFM=FB,LRECL=150,BLKSIZE=15000)
//RISKPRM  DD DSN=PROD.CONFIG.RISK.PARAMS,DISP=SHR
//SYSPRINT DD SYSOUT=*
//SYSUDUMP DD SYSOUT=*
//SYSOUT   DD SYSOUT=*
//*
//* STEP 5: SORT RISK OUTPUT BY SCORE (HIGHEST FIRST)
//*
//SORTOUT  EXEC PGM=SORT,COND=(4,LT)
//SYSOUT   DD SYSOUT=*
//SORTIN   DD DSN=WORK.RISK.OUTPUT.TEMP,DISP=SHR
//SORTOUT  DD DSN=PROD.RISK.SCORES.CURRENT,
//            DISP=(NEW,CATLG,DELETE),
//            UNIT=SYSDA,SPACE=(CYL,(50,25),RLSE),
//            DCB=(RECFM=FB,LRECL=150,BLKSIZE=15000)
//SYSIN    DD *
  SORT FIELDS=(11,3,ZD,D,1,10,CH,A)
/*
//*
//* STEP 6: GENERATE HIGH RISK CUSTOMER REPORT
//*
//HIGHRPT  EXEC PGM=RISKREPT,COND=(4,LT)
//STEPLIB  DD DSN=PROD.LOADLIB,DISP=SHR
//RISKIN   DD DSN=PROD.RISK.SCORES.CURRENT,DISP=SHR
//REPORT   DD SYSOUT=A,
//            DCB=(RECFM=FBA,LRECL=133,BLKSIZE=1330)
//HIGHRISK DD DSN=PROD.RISK.HIGH.ALERTS.D&DATE,
//            DISP=(NEW,CATLG,DELETE),
//            UNIT=SYSDA,SPACE=(CYL,(10,5),RLSE),
//            DCB=(RECFM=FB,LRECL=200,BLKSIZE=20000)
//SYSIN    DD *
  THRESHOLD=700
  INCLUDE_MEDIUM=N
/*
//*
//* STEP 7: EXPORT HIGH RISK TO FRAUD SYSTEM
//*
//EXPORT   EXEC PGM=FTPBATCH,COND=(4,LT)
//STEPLIB  DD DSN=PROD.NETLIB,DISP=SHR
//INPUT    DD DSN=PROD.RISK.HIGH.ALERTS.D&DATE,DISP=SHR
//OUTPUT   DD SYSOUT=B
//SYSPRINT DD SYSOUT=*
//SYSTSIN  DD *
  OPEN FRAUD.SYSTEM.HOST
  USER RISKFEED
  PUT PROD.RISK.HIGH.ALERTS.D&DATE HIGHRISK.FEED.&DATE
  QUIT
/*
//*
//* STEP 8: SEND COMPLETION NOTIFICATION
//*
//NOTIFY   EXEC PGM=IKJEFT01,COND=(4,LT)
//SYSTSPRT DD SYSOUT=*
//SYSTSIN  DD *
  SEND 'RISK SCORING COMPLETE - CHECK REPORTS' USER(RISKTEAM)
  SEND 'HIGH RISK COUNT: SEE REPORT' USER(COMPLIANCE)
/*
//*
//* STEP 9: CLEANUP WORK FILES IF SUCCESSFUL
//*
//CLEANUP2 EXEC PGM=IEFBR14,COND=(0,NE)
//WORK1    DD DSN=WORK.RISK.TRANS.EXTRACT,
//            DISP=(MOD,DELETE,DELETE)
//WORK2    DD DSN=WORK.RISK.OUTPUT.TEMP,
//            DISP=(MOD,DELETE,DELETE)
//*
//        PEND
//*
//EXECUTE  EXEC JOBPROC
